<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="题目解析 Phase1（函数调用） 函数与汇编对应 看函数名猜功能 在命令行把 rdi、rsi 截下来 一个是你的输入，一个是答案 唯一答案是 Computer science is not a boring subject Phase2（循环） 函数与汇编对应 phase_2_nums 结构体，处于数据段，不是代码段 (-D) 该代码段中有对应的默认值 123456789101112131415">
<meta property="og:type" content="article">
<meta property="og:title" content="BombLab writeup">
<meta property="og:url" content="https://cjinfdu.github.io/ics/BombLab-Comment/index.html">
<meta property="og:site_name" content="COMP130201.02 计算机系统基础">
<meta property="og:description" content="题目解析 Phase1（函数调用） 函数与汇编对应 看函数名猜功能 在命令行把 rdi、rsi 截下来 一个是你的输入，一个是答案 唯一答案是 Computer science is not a boring subject Phase2（循环） 函数与汇编对应 phase_2_nums 结构体，处于数据段，不是代码段 (-D) 该代码段中有对应的默认值 123456789101112131415">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-11-02T00:00:00.000Z">
<meta property="article:modified_time" content="2023-11-02T12:49:26.561Z">
<meta property="article:author" content="FDUICS-2023助教组">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/ics/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/ics/images/android-chrome-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/ics/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>BombLab writeup</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/ics/css/style.css">

    <!-- rss -->
    
    
<meta name="generator" content="Hexo 6.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body>
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/ics/">Home</a></li>
         
          <li><a href="/ics/staff/">Staff</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cjinfdu/ics">Github</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/ics/Assignment2/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/ics/CoroutineLab/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://cjinfdu.github.io/ics/BombLab-Comment/"><i class="fa fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://cjinfdu.github.io/ics/BombLab-Comment/&text=BombLab writeup"><i class="fa fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://cjinfdu.github.io/ics/BombLab-Comment/&is_video=false&description=BombLab writeup"><i class="fa fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BombLab writeup&body=Check out this article: https://cjinfdu.github.io/ics/BombLab-Comment/"><i class="fa fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://cjinfdu.github.io/ics/BombLab-Comment/&name=BombLab writeup&description="><i class="fa fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%A7%A3%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">题目解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#phase1%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">Phase1（函数调用）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase2%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.2.</span> <span class="toc-text">Phase2（循环）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase3%E5%88%86%E6%94%AF"><span class="toc-number">1.3.</span> <span class="toc-text">Phase3（分支）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase4%E9%80%92%E5%BD%92"><span class="toc-number">1.4.</span> <span class="toc-text">Phase4（递归）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase5%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.5.</span> <span class="toc-text">Phase5（面向对象）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E6%B1%87%E7%BC%96%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.1.</span> <span class="toc-text">面向对象机制的汇编实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase6%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.6.</span> <span class="toc-text">Phase6（循环队列）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#secret-phase%E6%BA%A2%E5%87%BA-%E8%8A%B1%E6%8C%87%E4%BB%A4"><span class="toc-number">1.7.</span> <span class="toc-text">Secret Phase（溢出 &amp; 花指令）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA"><span class="toc-number">1.7.1.</span> <span class="toc-text">溢出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%B1%E6%8C%87%E4%BB%A4"><span class="toc-number">1.7.2.</span> <span class="toc-text">花指令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E6%A0%87%E5%87%86%E8%A7%A3%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">非标准解法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%86%E7%A0%B4"><span class="toc-number">2.1.</span> <span class="toc-text">爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C"><span class="toc-number">2.2.</span> <span class="toc-text">符号执行</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index width mx-auto px2 my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        BombLab writeup
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">COMP130201.02 计算机系统基础</span>
      </span>
      
    <div class="postdate">
        <time datetime="2023-11-02T00:00:00.000Z" itemprop="datePublished">2023-11-02</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="题目解析">题目解析</h2>
<h3 id="phase1函数调用">Phase1（函数调用）</h3>
<p>函数与汇编对应 看函数名猜功能 在命令行把 rdi、rsi 截下来 一个是你的输入，一个是答案 唯一答案是 <code>Computer science is not a boring subject</code></p>
<h3 id="phase2循环">Phase2（循环）</h3>
<p>函数与汇编对应 phase_2_nums 结构体，处于数据段，不是代码段 (-D) 该代码段中有对应的默认值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">struct {</span><br><span class="line">    int nums[6] = {2, 4, 8, 16, 32, 64};</span><br><span class="line">    char is_pass_six = '\0'; // for secret phase</span><br><span class="line">    int base = BASE_IN_2;</span><br><span class="line">    int add_num = BASE_ADD_2;</span><br><span class="line">} phase_2_nums;</span><br><span class="line"></span><br><span class="line">0000000000406360 &lt;phase_2_nums&gt;:</span><br><span class="line">  406360:	02 00                	add    (%rax),%al # num[0]</span><br><span class="line">  406362:	00 00                	add    %al,(%rax)</span><br><span class="line">  406364:	04 00                	add    $0x0,%al  # num[4]</span><br><span class="line">  406366:	00 00                	add    %al,(%rax)</span><br><span class="line">  406368:	08 00                	or     %al,(%rax)  # num[8]</span><br><span class="line">  40636a:	00 00                	add    %al,(%rax)</span><br><span class="line">  40636c:	10 00                	adc    %al,(%rax) # num[16]</span><br><span class="line">  40636e:	00 00                	add    %al,(%rax)</span><br><span class="line">  406370:	20 00                	and    %al,(%rax) # num[32]</span><br><span class="line">  406372:	00 00                	add    %al,(%rax)</span><br><span class="line">  406374:	40 00 00             	add    %al,(%rax) # num[64]</span><br><span class="line">  406377:	00 00                	add    %al,(%rax)</span><br><span class="line">  406379:	00 00                	add    %al,(%rax)</span><br><span class="line">  40637b:	00 fc                	add    %bh,%ah   </span><br><span class="line">  40637d:	ff                   	(bad)  </span><br><span class="line">  40637e:	ff                   	(bad)  </span><br><span class="line">  40637f:	ff 01                	incl   (%rcx) # fc到ff是BASE_IN_2(-4)的补码，01 是BASE_ADD_2的值</span><br></pre></td></tr></table></figure>
<p>题目要求大家输入的每一个数字是前一个*(-4)+1, 即 <span class="math display"><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="45.927ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 20299.8 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(529,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1129,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(1598,0)"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mi" transform="translate(2314,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="msub" transform="translate(2780,0)"><g data-mml-node="mi"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(484,-150) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g></g><g data-mml-node="mo" transform="translate(3835.7,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mi" transform="translate(4891.5,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(5420.5,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(6020.5,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(6489.5,0)"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mi" transform="translate(7205.5,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="msub" transform="translate(7671.5,0)"><g data-mml-node="mi"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="TeXAtom" transform="translate(484,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g><g data-mml-node="mo" transform="translate(9575.4,0)"><path data-c="2217" d="M229 286Q216 420 216 436Q216 454 240 464Q241 464 245 464T251 465Q263 464 273 456T283 436Q283 419 277 356T270 286L328 328Q384 369 389 372T399 375Q412 375 423 365T435 338Q435 325 425 315Q420 312 357 282T289 250L355 219L425 184Q434 175 434 161Q434 146 425 136T401 125Q393 125 383 131T328 171L270 213Q283 79 283 63Q283 53 276 44T250 35Q231 35 224 44T216 63Q216 80 222 143T229 213L171 171Q115 130 110 127Q106 124 100 124Q87 124 76 134T64 161Q64 166 64 169T67 175T72 181T81 188T94 195T113 204T138 215T170 230T210 250L74 315Q65 324 65 338Q65 353 74 363T98 374Q106 374 116 368T171 328L229 286Z"></path></g><g data-mml-node="mo" transform="translate(10297.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mo" transform="translate(10686.6,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"></path></g><g data-mml-node="mn" transform="translate(11464.6,0)"><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z"></path></g><g data-mml-node="mo" transform="translate(11964.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"></path></g><g data-mml-node="mo" transform="translate(12575.8,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(13576,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g><g data-mml-node="mo" transform="translate(14076,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(14520.7,0)"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(15049.7,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(15649.7,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(16118.7,0)"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mi" transform="translate(16834.7,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="msub" transform="translate(17300.7,0)"><g data-mml-node="mi"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mn" transform="translate(484,-150) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g><g data-mml-node="mo" transform="translate(18188.3,0)"><path data-c="21" d="M78 661Q78 682 96 699T138 716T180 700T199 661Q199 654 179 432T158 206Q156 198 139 198Q121 198 119 206Q118 209 98 431T78 661ZM79 61Q79 89 97 105T141 121Q164 119 181 104T198 61Q198 31 181 16T139 1Q114 1 97 16T79 61Z"></path></g><g data-mml-node="mo" transform="translate(18744,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"></path></g><g data-mml-node="mn" transform="translate(19799.8,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></svg></mjx-container></span></p>
<p>一个参考答案是 <code>1 -3 13 -51 205 -819</code></p>
<h3 id="phase3分支">Phase3（分支）</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">401627:	48 89 7d d8          	mov    %rdi,-0x28(%rbp)</span><br><span class="line">40162b:	48 8d 75 ef          	lea    -0x11(%rbp),%rsi</span><br><span class="line">40162f:	48 8d 4d f0          	lea    -0x10(%rbp),%rcx</span><br><span class="line">401633:	48 8d 55 f4          	lea    -0xc(%rbp),%rdx</span><br><span class="line">401637:	48 8b 45 d8          	mov    -0x28(%rbp),%rax</span><br><span class="line">40163b:	49 89 f0             	mov    %rsi,%r8</span><br><span class="line">40163e:	48 8d 35 03 1c 00 00 	lea    0x1c03(%rip),%rsi        # 403248 &lt;_ZNSt8__detailL19_S_invalid_state_idE+0x8&gt;</span><br><span class="line">401645:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">401648:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">40164d:	e8 0e fb ff ff       	callq  401160 &lt;__isoc99_sscanf@plt&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">403230 09000000 0a000000 0b000000 0c000000  ................</span><br><span class="line">403240 ffffffff ffffffff 25642025 64202563  ........%d %d %c</span><br><span class="line">403250 00000000 2ae5ffff 7ee4ffff 98e4ffff  ....*...~.......</span><br></pre></td></tr></table></figure>
<p>函数开头调用了 <code>sscanf(input, "%d %d %c", -0xc(%rbp), -0x10(%rbp), -0x11(%rbp))</code>，从 input 字符串中读取了两个数字和一个字符。下记这三个变量为 vc, v10, v11。</p>
<p>在经过返回值检查后，进入了一大堆比较和跳转，根据 vc 的值跳转到不同的位置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">401660:	8b 45 f4             	mov    -0xc(%rbp),%eax</span><br><span class="line">401663:	3d 62 02 00 00       	cmp    $0x262,%eax</span><br><span class="line">401668:	0f 84 fb 00 00 00    	je     401769 &lt;phase_3+0x14e&gt;</span><br><span class="line">40166e:	3d 62 02 00 00       	cmp    $0x262,%eax</span><br><span class="line">401673:	0f 8f 05 01 00 00    	jg     40177e &lt;phase_3+0x163&gt;   # boom (signed vc &gt; 0x262)</span><br><span class="line">401679:	3d e9 00 00 00       	cmp    $0xe9,%eax</span><br><span class="line">40167e:	0f 84 d0 00 00 00    	je     401754 &lt;phase_3+0x139&gt;</span><br><span class="line">401684:	3d e9 00 00 00       	cmp    $0xe9,%eax</span><br><span class="line">401689:	0f 8f ef 00 00 00    	jg     40177e &lt;phase_3+0x163&gt;   # boom (signed vc &gt; 0xe9)</span><br><span class="line">40168f:	83 f8 22             	cmp    $0x22,%eax</span><br><span class="line">401692:	7f 34                	jg     4016c8 &lt;phase_3+0xad&gt;</span><br><span class="line">401694:	85 c0                	test   %eax,%eax</span><br><span class="line">401696:	0f 8e e2 00 00 00    	jle    40177e &lt;phase_3+0x163&gt;   # boom (signed vc &lt;= 0)</span><br><span class="line">40169c:	83 f8 22             	cmp    $0x22,%eax</span><br><span class="line">40169f:	0f 87 d9 00 00 00    	ja     40177e &lt;phase_3+0x163&gt;   # boom (unsigned vc &gt; 0x22)</span><br></pre></td></tr></table></figure>
<p>目前为止还很正常，但在确认 unsigned vc &lt;= 0x22 之后就来了一些奇奇怪怪的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">4016a5:	89 c0                	mov    %eax,%eax</span><br><span class="line">4016a7:	48 8d 14 85 00 00 00 	lea    0x0(,%rax,4),%rdx        # rdx = 4 * vc</span><br><span class="line">4016ae:	00 </span><br><span class="line">4016af:	48 8d 05 9e 1b 00 00 	lea    0x1b9e(%rip),%rax        # 403254</span><br><span class="line">4016b6:	8b 04 02             	mov    (%rdx,%rax,1),%eax       # eax = *(int*)(0x403254 + 4 * vc)</span><br><span class="line"># ((int*)0x403254)[vc]</span><br><span class="line">4016b9:	48 98                	cltq</span><br><span class="line">4016bb:	48 8d 15 92 1b 00 00 	lea    0x1b92(%rip),%rdx        # 403254</span><br><span class="line">4016c2:	48 01 d0             	add    %rdx,%rax                # rax = 0x403254 + ((int*)0x403254)[vc]</span><br><span class="line">4016c5:	3e ff e0             	notrack jmpq *%rax</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">403250 00000000 2ae5ffff 7ee4ffff 98e4ffff  ....*...~.......</span><br><span class="line">403260 2ae5ffff 2ae5ffff b2e4ffff 2ae5ffff  *...*.......*...</span><br><span class="line">403270 2ae5ffff 2ae5ffff 2ae5ffff 2ae5ffff  *...*...*...*...</span><br><span class="line">403280 2ae5ffff 2ae5ffff c5e4ffff 2ae5ffff  *...*.......*...</span><br><span class="line">403290 2ae5ffff 2ae5ffff 2ae5ffff 2ae5ffff  *...*...*...*...</span><br><span class="line">4032a0 2ae5ffff 2ae5ffff 2ae5ffff 2ae5ffff  *...*...*...*...</span><br><span class="line">4032b0 2ae5ffff 2ae5ffff 2ae5ffff 2ae5ffff  *...*...*...*...</span><br><span class="line">4032c0 2ae5ffff 2ae5ffff 2ae5ffff 2ae5ffff  *...*...*...*...</span><br><span class="line">4032d0 2ae5ffff 2ae5ffff 2ae5ffff d8e4ffff  *...*...*.......</span><br></pre></td></tr></table></figure>
<p>让我们假设 vc == 0x22，那么首先 <code>*(int*)(0x403254 + 4 * vc)</code> 就是 0xffffd8e4（注意小端法），经过符号拓展（cltq），此时 rax 的值为 0xffffffffffffd8e4，也就是补码表示的 -10012。我们将这个值加到 0x403254 上，可以得到 0x400B38，一个位于 phase_3 函数中的地址。</p>
<p>这里其实就是书本 3.6.8 中提到的 switch 的跳转表机制（P159）。0x403254 处存放的就是 <code>switch(vc)</code> 的<strong>跳转表</strong>，其中记录的偏移（比如 0xffffd8e4）加上跳转表自己的地址（0x403254）就可以得到跳转目标的地址。</p>
<p>但这里会产生一个疑惑：为什么对同一个变量 vc 的比较，一会采用跳转表，一会又采用直接比较的方式呢？</p>
<p>书上提到：“GCC 根据 switch 目标的数量和稀疏程度来翻译 switch 语句”，因此 GCC 这里使用了一种优化策略，将部分 switch 目标装载到跳转表中，部分差得过大的目标就用比较来实现分支跳转。试想如果把 0x262 也装入跳转表，那跳转表要特别特别大才行，这对于空间来说太浪费了。</p>
<p>总之，我们可以给每个 switch 跳转目标都打上注释：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">4016d2:	c6 45 ff 6f          	movb   $0x6f,-0x1(%rbp)         # vc == 0x1</span><br><span class="line">4016d6:	8b 45 f0             	mov    -0x10(%rbp),%eax</span><br><span class="line">4016d9:	83 f8 01             	cmp    $0x1,%eax</span><br><span class="line">4016dc:	0f 84 a3 00 00 00    	je     401785 &lt;phase_3+0x16a&gt;</span><br><span class="line">4016e2:	e8 61 09 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">4016e7:	e9 99 00 00 00       	jmpq   401785 &lt;phase_3+0x16a&gt;</span><br><span class="line">4016ec:	c6 45 ff 76          	movb   $0x76,-0x1(%rbp)         # vc == 0x2</span><br><span class="line">4016f0:	8b 45 f0             	mov    -0x10(%rbp),%eax</span><br><span class="line">4016f3:	83 f8 03             	cmp    $0x3,%eax</span><br><span class="line">4016f6:	0f 84 8c 00 00 00    	je     401788 &lt;phase_3+0x16d&gt;</span><br><span class="line">4016fc:	e8 47 09 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">401701:	e9 82 00 00 00       	jmpq   401788 &lt;phase_3+0x16d&gt;</span><br><span class="line">401706:	c6 45 ff 65          	movb   $0x65,-0x1(%rbp)         # vc == 0x5</span><br><span class="line">40170a:	8b 45 f0             	mov    -0x10(%rbp),%eax</span><br><span class="line">40170d:	83 f8 08             	cmp    $0x8,%eax</span><br><span class="line">401710:	74 79                	je     40178b &lt;phase_3+0x170&gt;</span><br><span class="line">401712:	e8 31 09 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">401717:	eb 72                	jmp    40178b &lt;phase_3+0x170&gt;</span><br><span class="line">401719:	c6 45 ff 72          	movb   $0x72,-0x1(%rbp)         # vc == 0xd</span><br><span class="line">40171d:	8b 45 f0             	mov    -0x10(%rbp),%eax</span><br><span class="line">401720:	83 f8 15             	cmp    $0x15,%eax</span><br><span class="line">401723:	74 69                	je     40178e &lt;phase_3+0x173&gt;</span><br><span class="line">401725:	e8 1e 09 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">40172a:	eb 62                	jmp    40178e &lt;phase_3+0x173&gt;</span><br><span class="line">40172c:	c6 45 ff 66          	movb   $0x66,-0x1(%rbp)         # vc == 0x22</span><br><span class="line">401730:	8b 45 f0             	mov    -0x10(%rbp),%eax</span><br><span class="line">401733:	83 f8 37             	cmp    $0x37,%eax</span><br><span class="line">401736:	74 59                	je     401791 &lt;phase_3+0x176&gt;</span><br><span class="line">401738:	e8 0b 09 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">40173d:	eb 52                	jmp    401791 &lt;phase_3+0x176&gt;</span><br><span class="line">40173f:	c6 45 ff 6c          	movb   $0x6c,-0x1(%rbp)         # vc == 0x59</span><br><span class="line">401743:	8b 45 f0             	mov    -0x10(%rbp),%eax</span><br><span class="line">401746:	3d 90 00 00 00       	cmp    $0x90,%eax</span><br><span class="line">40174b:	74 47                	je     401794 &lt;phase_3+0x179&gt;</span><br><span class="line">40174d:	e8 f6 08 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">401752:	eb 40                	jmp    401794 &lt;phase_3+0x179&gt;</span><br><span class="line">401754:	c6 45 ff 6f          	movb   $0x6f,-0x1(%rbp)         # vc == 0xe9</span><br><span class="line">401758:	8b 45 f0             	mov    -0x10(%rbp),%eax</span><br><span class="line">40175b:	3d 79 01 00 00       	cmp    $0x179,%eax</span><br><span class="line">401760:	74 35                	je     401797 &lt;phase_3+0x17c&gt;</span><br><span class="line">401762:	e8 e1 08 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">401767:	eb 2e                	jmp    401797 &lt;phase_3+0x17c&gt;</span><br><span class="line">401769:	c6 45 ff 77          	movb   $0x77,-0x1(%rbp)         # vc == 0x262</span><br><span class="line">40176d:	8b 45 f0             	mov    -0x10(%rbp),%eax</span><br><span class="line">401770:	3d db 03 00 00       	cmp    $0x3db,%eax</span><br><span class="line">401775:	74 23                	je     40179a &lt;phase_3+0x17f&gt;</span><br><span class="line">401777:	e8 cc 08 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">40177c:	eb 1c                	jmp    40179a &lt;phase_3+0x17f&gt;</span><br><span class="line">40177e:	e8 c5 08 00 00       	callq  402048 &lt;explode_bomb&gt;    # vc == 跳转表其他目标</span><br></pre></td></tr></table></figure>
<p>在上面这些代码中，首先根据 vc 的值不同，为 <code>-0x1(%rbp)</code> 赋了值，这个变量我们记作 v1；然后对 v10 的值进行了不同的检测，总得来说需要满足这些条件其中之一：</p>
<ul>
<li>vc == 0x01 &amp;&amp; v10 == 0x01</li>
<li>vc == 0x02 &amp;&amp; v10 == 0x03</li>
<li>vc == 0x05 &amp;&amp; v10 == 0x08</li>
<li>vc == 0x0d &amp;&amp; v10 == 0x15</li>
<li>vc == 0x22 &amp;&amp; v10 == 0x37</li>
<li>vc == 0x59 &amp;&amp; v10 == 0x90</li>
<li>vc == 0xe9 &amp;&amp; v10 == 0x179</li>
<li>vc == 0x262 &amp;&amp; v10 == 0x3db</li>
</ul>
<p>然后，经过一些无意义的跳转，我们来到了 phase3 的最后一部分代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">40179b:	0f b6 45 ef          	movzbl -0x11(%rbp),%eax</span><br><span class="line">40179f:	38 45 ff             	cmp    %al,-0x1(%rbp)</span><br><span class="line">4017a2:	74 05                	je     4017a9 &lt;phase_3+0x18e&gt;</span><br><span class="line">4017a4:	e8 9f 08 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">4017a9:	90                   	nop</span><br><span class="line">4017aa:	c9                   	leaveq </span><br><span class="line">4017ab:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p>这里检测了 v11 是否与 v1 相等，如果不相等的话就会爆炸。因此，我们可以扩充上面的表，得到所有可能的答案组合：</p>
<ul>
<li>vc == 0x01 &amp;&amp; v10 == 0x01 &amp;&amp; v11 == 0x6f</li>
<li>vc == 0x02 &amp;&amp; v10 == 0x03 &amp;&amp; v11 == 0x76</li>
<li>vc == 0x05 &amp;&amp; v10 == 0x08 &amp;&amp; v11 == 0x65</li>
<li>vc == 0x0d &amp;&amp; v10 == 0x15 &amp;&amp; v11 == 0x72</li>
<li>vc == 0x22 &amp;&amp; v10 == 0x37 &amp;&amp; v11 == 0x66</li>
<li>vc == 0x59 &amp;&amp; v10 == 0x90 &amp;&amp; v11 == 0x6c</li>
<li>vc == 0xe9 &amp;&amp; v10 == 0x179 &amp;&amp; v11 == 0x6f</li>
<li>vc == 0x262 &amp;&amp; v10 == 0x3db &amp;&amp; v11 == 0x77</li>
</ul>
<p>在文档中有提示说 secret_phase 的线索隐藏在 phase_3 中，其实这里的提示就是 v11 的取值。将这些十六进制数理解为 ASCII，就可以得到一个英文单词。</p>
<ul>
<li>vc == 0x01 &amp;&amp; v10 == 0x01 &amp;&amp; v11 == 'o'</li>
<li>vc == 0x02 &amp;&amp; v10 == 0x03 &amp;&amp; v11 == 'v'</li>
<li>vc == 0x05 &amp;&amp; v10 == 0x08 &amp;&amp; v11 == 'e'</li>
<li>vc == 0x0d &amp;&amp; v10 == 0x15 &amp;&amp; v11 == 'r'</li>
<li>vc == 0x22 &amp;&amp; v10 == 0x37 &amp;&amp; v11 == 'f'</li>
<li>vc == 0x59 &amp;&amp; v10 == 0x90 &amp;&amp; v11 == 'l'</li>
<li>vc == 0xe9 &amp;&amp; v10 == 0x179 &amp;&amp; v11 == 'o'</li>
<li>vc == 0x262 &amp;&amp; v10 == 0x3db &amp;&amp; v11 == 'w'</li>
</ul>
<p>由于汇编层面中没有类型信息，所以汇编语言不会主动告诉你哪些数据是字符，哪些数据是数字。因此，在进行逆向工程时，注意 0x20~0x7f 之间的数据，这个范围是可见字符的范围。</p>
<h3 id="phase4递归">Phase4（递归）</h3>
<p>第四阶段是一个递归调用自身的函数，我们需要构造出特定的参数，使其返回特定的值。 我们首先分析 phase_4 函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">401800:	48 89 7d e8          	mov    %rdi,-0x18(%rbp)</span><br><span class="line">401804:	48 8d 55 f0          	lea    -0x10(%rbp),%rdx</span><br><span class="line">401808:	48 8b 45 e8          	mov    -0x18(%rbp),%rax</span><br><span class="line">40180c:	48 8d 35 cd 1a 00 00 	lea    0x1acd(%rip),%rsi        # 4032e0 &lt;_ZNSt8__detailL19_S_invalid_state_idE+0xa0&gt;</span><br><span class="line">401813:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">401816:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">40181b:	e8 40 f9 ff ff       	callq  401160 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">401820:	83 f8 01             	cmp    $0x1,%eax</span><br><span class="line">401823:	0f 95 c0             	setne  %al</span><br><span class="line">401826:	84 c0                	test   %al,%al</span><br><span class="line">401828:	74 05                	je     40182f &lt;phase_4+0x3b&gt;</span><br><span class="line">40182a:	e8 19 08 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4032d0 2ae5ffff 2ae5ffff 2ae5ffff d8e4ffff  *...*...*.......</span><br><span class="line">4032e0 256c6c64 00257320 256400e6 9d80e69d  %lld.%s %d......</span><br><span class="line">4032f0 80e69d80 efbc8100 e98080e9 8080e980  ................</span><br></pre></td></tr></table></figure>
<p>首先，函数读入一个长整型，并存放到 <code>-0x10(%rbp)</code> 中，我们将其记为 v10。然后函数进行了一些赋值，将这个长整型拆了开来：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">40182f:	48 8b 45 f0          	mov    -0x10(%rbp),%rax</span><br><span class="line">401833:	48 c1 f8 20          	sar    $0x20,%rax</span><br><span class="line">401837:	89 45 fc             	mov    %eax,-0x4(%rbp)    # v4 = signed v10 &gt;&gt; 32</span><br><span class="line">40183a:	48 8b 45 f0          	mov    -0x10(%rbp),%rax</span><br><span class="line">40183e:	89 45 f8             	mov    %eax,-0x8(%rbp)    # v8 = (int) v10</span><br></pre></td></tr></table></figure>
<p>然后，函数进行了一系列的检查。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">401841:	83 7d fc 00          	cmpl   $0x0,-0x4(%rbp)</span><br><span class="line">401845:	0f 9e c2             	setle  %dl                # dl = v4 &lt;= 0</span><br><span class="line">401848:	83 7d fc 0e          	cmpl   $0xe,-0x4(%rbp)</span><br><span class="line">40184c:	0f 9f c0             	setg   %al                # al = v4 &gt;= 0xe</span><br><span class="line">40184f:	09 d0                	or     %edx,%eax</span><br><span class="line">401851:	0f b6 d0             	movzbl %al,%edx           # edx = (v4 &lt;= 0) || (v4 &gt;= 0xe)</span><br><span class="line"></span><br><span class="line">401854:	83 7d f8 00          	cmpl   $0x0,-0x8(%rbp)</span><br><span class="line">401858:	0f 9e c0             	setle  %al                # al = v8 &lt;= 0</span><br><span class="line">40185b:	0f b6 c0             	movzbl %al,%eax</span><br><span class="line">40185e:	09 c2                	or     %eax,%edx          # edx = (v4 &lt;= 0) || (v4 &gt;= 0xe) || (v8 &lt;= 0)</span><br><span class="line">401860:	83 7d f8 0e          	cmpl   $0xe,-0x8(%rbp)</span><br><span class="line">401864:	0f 9f c0             	setg   %al                # al = v8 &gt; 0xe</span><br><span class="line">401867:	0f b6 c0             	movzbl %al,%eax</span><br><span class="line">40186a:	09 d0                	or     %edx,%eax          # eax = (v4 &lt;= 0) || (v4 &gt; 0xe) || (v8 &lt;= 0) || (v8 &gt; 0xe)</span><br><span class="line">40186c:	85 c0                	test   %eax,%eax</span><br><span class="line">40186e:	74 05                	je     401875 &lt;phase_4+0x81&gt;</span><br><span class="line">401870:	e8 d3 07 00 00       	callq  402048 &lt;explode_bomb&gt;  # if (eax) boom</span><br></pre></td></tr></table></figure>
<p>检查需要 v4 和 v8 都是介于 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.678ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2951.7 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"></path></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g><g data-mml-node="mo" transform="translate(889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mi" transform="translate(1333.7,0)"><path data-c="1D438" d="M492 213Q472 213 472 226Q472 230 477 250T482 285Q482 316 461 323T364 330H312Q311 328 277 192T243 52Q243 48 254 48T334 46Q428 46 458 48T518 61Q567 77 599 117T670 248Q680 270 683 272Q690 274 698 274Q718 274 718 261Q613 7 608 2Q605 0 322 0H133Q31 0 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q146 66 215 342T285 622Q285 629 281 629Q273 632 228 634H197Q191 640 191 642T193 659Q197 676 203 680H757Q764 676 764 669Q764 664 751 557T737 447Q735 440 717 440H705Q698 445 698 453L701 476Q704 500 704 528Q704 558 697 578T678 609T643 625T596 632T532 634H485Q397 633 392 631Q388 629 386 622Q385 619 355 499T324 377Q347 376 372 376H398Q464 376 489 391T534 472Q538 488 540 490T557 493Q562 493 565 493T570 492T572 491T574 487T577 483L544 351Q511 218 508 216Q505 213 492 213Z"></path></g><g data-mml-node="mi" transform="translate(2097.7,0)"><path data-c="210E" d="M137 683Q138 683 209 688T282 694Q294 694 294 685Q294 674 258 534Q220 386 220 383Q220 381 227 388Q288 442 357 442Q411 442 444 415T478 336Q478 285 440 178T402 50Q403 36 407 31T422 26Q450 26 474 56T513 138Q516 149 519 151T535 153Q555 153 555 145Q555 144 551 130Q535 71 500 33Q466 -10 419 -10H414Q367 -10 346 17T325 74Q325 90 361 192T398 345Q398 404 354 404H349Q266 404 205 306L198 293L164 158Q132 28 127 16Q114 -11 83 -11Q69 -11 59 -2T48 16Q48 30 121 320L195 616Q195 629 188 632T149 637H128Q122 643 122 645T124 664Q129 683 137 683Z"></path></g><g data-mml-node="mo" transform="translate(2673.7,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span> 之间的数字。</p>
<p>然后我们来看末尾：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">401875:	8b 45 fc             	mov    -0x4(%rbp),%eax</span><br><span class="line">401878:	89 c7                	mov    %eax,%edi</span><br><span class="line">40187a:	e8 2d ff ff ff       	callq  4017ac &lt;_ZL4hopei&gt;</span><br><span class="line">40187f:	3d 00 00 00 01       	cmp    $0x1000000,%eax</span><br><span class="line">401884:	0f 95 c0             	setne  %al</span><br><span class="line">401887:	84 c0                	test   %al,%al</span><br><span class="line">401889:	74 05                	je     401890 &lt;phase_4+0x9c&gt;</span><br><span class="line">40188b:	e8 b8 07 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br><span class="line">401890:	90                   	nop</span><br><span class="line">401891:	c9                   	leaveq </span><br><span class="line">401892:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p>我们需要让 <code>_ZL4hopei(v4)</code>（下称hope）返回 0x1000000 来通关本关。我们来看 hope 函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4017b8:	89 7d ec             	mov    %edi,-0x14(%rbp)</span><br><span class="line">4017bb:	83 7d ec 00          	cmpl   $0x0,-0x14(%rbp)</span><br><span class="line">4017bf:	75 07                	jne    4017c8 &lt;_ZL4hopei+0x1c&gt;</span><br><span class="line">4017c1:	b8 01 00 00 00       	mov    $0x1,%eax</span><br><span class="line">4017c6:	eb 2a                	jmp    4017f2 &lt;_ZL4hopei+0x46&gt;</span><br></pre></td></tr></table></figure>
<p>如果参数（下称 v14）为 0 的话，直接返回 1；否则继续处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">4017c8:	8b 45 ec             	mov    -0x14(%rbp),%eax</span><br><span class="line">4017cb:	d1 f8                	sar    %eax</span><br><span class="line">4017cd:	89 c7                	mov    %eax,%edi</span><br><span class="line">4017cf:	e8 d8 ff ff ff       	callq  4017ac &lt;_ZL4hopei&gt;</span><br><span class="line">4017d4:	89 45 fc             	mov    %eax,-0x4(%rbp)      # v4 = hope(n &gt;&gt; 1)</span><br></pre></td></tr></table></figure>
<p>这里递归调用了自身，并把返回值存放到了 v4 中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">4017d7:	8b 45 ec             	mov    -0x14(%rbp),%eax</span><br><span class="line">4017da:	83 e0 01             	and    $0x1,%eax</span><br><span class="line">4017dd:	85 c0                	test   %eax,%eax</span><br><span class="line">4017df:	74 0b                	je     4017ec &lt;_ZL4hopei+0x40&gt;</span><br><span class="line"></span><br><span class="line">4017e1:	8b 45 fc             	mov    -0x4(%rbp),%eax</span><br><span class="line">4017e4:	0f af c0             	imul   %eax,%eax</span><br><span class="line">4017e7:	c1 e0 02             	shl    $0x2,%eax</span><br><span class="line">4017ea:	eb 06                	jmp    4017f2 &lt;_ZL4hopei+0x46&gt;</span><br><span class="line"></span><br><span class="line">4017ec:	8b 45 fc             	mov    -0x4(%rbp),%eax</span><br><span class="line">4017ef:	0f af c0             	imul   %eax,%eax</span><br><span class="line"></span><br><span class="line">4017f2:	c9                   	leaveq </span><br><span class="line">4017f3:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p>这里如果 <code>v14 &amp; 1 == 0</code>（v14 是偶数），那么会返回 v4^2，否则会返回 4 * (v4^2)。</p>
<p>我们可以把这个函数翻译成 C 语言，来更好地理解它：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">hope</span><span class="params">(<span class="type">int</span> v14)</span> {</span><br><span class="line">    <span class="keyword">if</span>(v14 == <span class="number">0</span>) <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> v4 = hope(v14 &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (v14 &amp; <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> v4 * v4 * <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> v4 * v4;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>可以看到，这里的 v14 类似于一个 bit vector，每一位都会指使当前层递归如何处理下一层递归返回的数字，直到最后一次递归直接返回 1。</p>
<p>我们可以假设内层递归返回的数是 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.152ex" height="1.932ex" role="img" focusable="false" viewBox="0 -853.7 951.4 853.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></g></svg></mjx-container></span>，当前层可以选择返回 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.952ex" height="1.932ex" role="img" focusable="false" viewBox="0 -853.7 1305 853.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g></g></g></g></g></svg></mjx-container></span> 或者 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="4.997ex" height="1.932ex" role="img" focusable="false" viewBox="0 -853.7 2208.6 853.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mi" transform="translate(500,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"></path></g><g data-mml-node="mo" transform="translate(1021,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"></path></g><g data-mml-node="mn" transform="translate(1799,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></g></svg></mjx-container></span>。我们需要思考的问题是，如何从 1 变成 0x1000000，也就是从 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.119ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 936.6 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="mn" transform="translate(533,363) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"></path></g></g></g></g></svg></mjx-container></span> 变成 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.919ex" height="1.904ex" role="img" focusable="false" viewBox="0 -841.7 1290.1 841.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g><g data-mml-node="TeXAtom" transform="translate(533,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path><path data-c="34" d="M462 0Q444 3 333 3Q217 3 199 0H190V46H221Q241 46 248 46T265 48T279 53T286 61Q287 63 287 115V165H28V211L179 442Q332 674 334 675Q336 677 355 677H373L379 671V211H471V165H379V114Q379 73 379 66T385 54Q393 47 442 46H471V0H462ZM293 211V545L74 212L183 211H293Z" transform="translate(500,0)"></path></g></g></g></g></g></svg></mjx-container></span>，同时需要满足这个 bit vector 的值不超过 0xe。</p>
<p>抽象出这个模型之后，我们很容易想到 k 可以这样变化：0-&gt;2-&gt;6-&gt;12-&gt;24，与之对应的 bit vector 也就是 0b1100，即 0xc。其他的路径也存在，但都超过了 0xe。</p>
<p>因此，这道题的答案就是 <code>(0xc &lt;&lt; 0x20) || 一个∈(0, 0xe]的数字</code>，具体来说就是 <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="33.532ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 14821.2 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D44E" d="M33 157Q33 258 109 349T280 441Q331 441 370 392Q386 422 416 422Q429 422 439 414T449 394Q449 381 412 234T374 68Q374 43 381 35T402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487Q506 153 506 144Q506 138 501 117T481 63T449 13Q436 0 417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157ZM351 328Q351 334 346 350T323 385T277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q217 26 254 59T298 110Q300 114 325 217T351 328Z"></path></g><g data-mml-node="mi" transform="translate(529,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1129,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mo" transform="translate(1875.8,0)"><path data-c="2208" d="M84 250Q84 372 166 450T360 539Q361 539 377 539T419 540T469 540H568Q583 532 583 520Q583 511 570 501L466 500Q355 499 329 494Q280 482 242 458T183 409T147 354T129 306T124 272V270H568Q583 262 583 250T568 230H124V228Q124 207 134 177T167 112T231 48T328 7Q355 1 466 0H570Q583 -10 583 -20Q583 -32 568 -40H471Q464 -40 446 -40T417 -41Q262 -41 172 45Q84 127 84 250Z"></path></g><g data-mml-node="mo" transform="translate(2820.6,0)"><path data-c="5B" d="M118 -250V750H255V710H158V-210H255V-250H118Z"></path></g><g data-mml-node="mn" transform="translate(3098.6,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(1500,0)"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(2000,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(2500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(3000,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(3500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(4000,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(4500,0)"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(5000,0)"></path></g><g data-mml-node="mo" transform="translate(8598.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"></path></g><g data-mml-node="mn" transform="translate(9043.2,0)"><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z"></path><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z" transform="translate(500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(1000,0)"></path><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z" transform="translate(1500,0)"></path><path data-c="39" d="M352 287Q304 211 232 211Q154 211 104 270T44 396Q42 412 42 436V444Q42 537 111 606Q171 666 243 666Q245 666 249 666T257 665H261Q273 665 286 663T323 651T370 619T413 560Q456 472 456 334Q456 194 396 97Q361 41 312 10T208 -22Q147 -22 108 7T68 93T121 149Q143 149 158 135T173 96Q173 78 164 65T148 49T135 44L131 43Q131 41 138 37T164 27T206 22H212Q272 22 313 86Q352 142 352 280V287ZM244 248Q292 248 321 297T351 430Q351 508 343 542Q341 552 337 562T323 588T293 615T246 625Q208 625 181 598Q160 576 154 546T147 441Q147 358 152 329T172 282Q197 248 244 248Z" transform="translate(2000,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(2500,0)"></path><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(3000,0)"></path><path data-c="37" d="M55 458Q56 460 72 567L88 674Q88 676 108 676H128V672Q128 662 143 655T195 646T364 644H485V605L417 512Q408 500 387 472T360 435T339 403T319 367T305 330T292 284T284 230T278 162T275 80Q275 66 275 52T274 28V19Q270 2 255 -10T221 -22Q210 -22 200 -19T179 0T168 40Q168 198 265 368Q285 400 349 489L395 552H302Q128 552 119 546Q113 543 108 522T98 479L95 458V455H55V458Z" transform="translate(3500,0)"></path><path data-c="35" d="M164 157Q164 133 148 117T109 101H102Q148 22 224 22Q294 22 326 82Q345 115 345 210Q345 313 318 349Q292 382 260 382H254Q176 382 136 314Q132 307 129 306T114 304Q97 304 95 310Q93 314 93 485V614Q93 664 98 664Q100 666 102 666Q103 666 123 658T178 642T253 634Q324 634 389 662Q397 666 402 666Q410 666 410 648V635Q328 538 205 538Q174 538 149 544L139 546V374Q158 388 169 396T205 412T256 420Q337 420 393 355T449 201Q449 109 385 44T229 -22Q148 -22 99 32T50 154Q50 178 61 192T84 210T107 214Q132 214 148 197T164 157Z" transform="translate(4000,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(4500,0)"></path><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z" transform="translate(5000,0)"></path></g><g data-mml-node="mo" transform="translate(14543.2,0)"><path data-c="5D" d="M22 710V750H159V-250H22V-210H119V710H22Z"></path></g></g></g></svg></mjx-container></span>。</p>
<h3 id="phase5面向对象">Phase5（面向对象）</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">4018a0:	48 89 7d b8          	mov    %rdi,-0x48(%rbp)</span><br><span class="line">4018a4:	48 8d 4d cc          	lea    -0x34(%rbp),%rcx</span><br><span class="line">4018a8:	48 8d 55 d0          	lea    -0x30(%rbp),%rdx</span><br><span class="line">4018ac:	48 8b 45 b8          	mov    -0x48(%rbp),%rax</span><br><span class="line">4018b0:	48 8d 35 2e 1a 00 00 	lea    0x1a2e(%rip),%rsi        # 4032e5</span><br><span class="line">4018b7:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">4018ba:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">4018bf:	e8 9c f8 ff ff       	callq  401160 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">4018c4:	83 f8 02             	cmp    $0x2,%eax</span><br><span class="line">4018c7:	0f 95 c0             	setne  %al</span><br><span class="line">4018ca:	84 c0                	test   %al,%al</span><br><span class="line">4018cc:	74 05                	je     4018d3 &lt;phase_5+0x40&gt;</span><br><span class="line">4018ce:	e8 75 07 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4032d0 2ae5ffff 2ae5ffff 2ae5ffff d8e4ffff  *...*...*.......</span><br><span class="line">4032e0 256c6c64 00257320 256400e6 9d80e69d  %lld.%s %d......</span><br><span class="line">4032f0 80e69d80 efbc8100 e98080e9 8080e980  ................</span><br></pre></td></tr></table></figure>
<p>我们可以看到，第五阶段会读取一个字符串和一个数字，并分别存放在 <code>-0x30(%rbp)</code> 和 <code>-0x34(%rbp)</code> 中，后面我们将其记为 buf 和 v34。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">4018d3:	48 8d 45 d0          	lea    -0x30(%rbp),%rax</span><br><span class="line">4018d7:	48 8d 35 0d 1a 00 00 	lea    0x1a0d(%rip),%rsi        # 4032eb</span><br><span class="line">4018de:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">4018e1:	e8 fa f8 ff ff       	callq  4011e0 &lt;strcmp@plt&gt;</span><br><span class="line">4018e6:	85 c0                	test   %eax,%eax</span><br><span class="line">4018e8:	75 1b                	jne    401905 &lt;phase_5+0x72&gt;</span><br><span class="line">4018ea:	bf 10 00 00 00       	mov    $0x10,%edi</span><br><span class="line">4018ef:	e8 8c f8 ff ff       	callq  401180 &lt;_Znwm@plt&gt;</span><br><span class="line">4018f4:	48 89 c3             	mov    %rax,%rbx</span><br><span class="line">4018f7:	48 89 df             	mov    %rbx,%rdi</span><br><span class="line">4018fa:	e8 c9 05 00 00       	callq  401ec8 &lt;_ZN10worldline1C1Ev&gt;</span><br><span class="line">4018ff:	48 89 5d e8          	mov    %rbx,-0x18(%rbp)</span><br><span class="line">401903:	eb 69                	jmp    40196e &lt;phase_5+0xdb&gt;</span><br><span class="line">401905:	48 8d 45 d0          	lea    -0x30(%rbp),%rax</span><br><span class="line">401909:	48 8d 35 e8 19 00 00 	lea    0x19e8(%rip),%rsi        # 4032f8</span><br><span class="line">401910:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">401913:	e8 c8 f8 ff ff       	callq  4011e0 &lt;strcmp@plt&gt;</span><br><span class="line">401918:	85 c0                	test   %eax,%eax</span><br><span class="line">40191a:	75 1b                	jne    401937 &lt;phase_5+0xa4&gt;</span><br><span class="line">40191c:	bf 10 00 00 00       	mov    $0x10,%edi</span><br><span class="line">401921:	e8 5a f8 ff ff       	callq  401180 &lt;_Znwm@plt&gt;</span><br><span class="line">401926:	48 89 c3             	mov    %rax,%rbx</span><br><span class="line">401929:	48 89 df             	mov    %rbx,%rdi</span><br><span class="line">40192c:	e8 17 06 00 00       	callq  401f48 &lt;_ZN10worldline2C1Ev&gt;</span><br><span class="line">401931:	48 89 5d e8          	mov    %rbx,-0x18(%rbp)</span><br><span class="line">401935:	eb 37                	jmp    40196e &lt;phase_5+0xdb&gt;</span><br><span class="line">401937:	48 8d 45 d0          	lea    -0x30(%rbp),%rax</span><br><span class="line">40193b:	48 8d 35 c3 19 00 00 	lea    0x19c3(%rip),%rsi        # 403305</span><br><span class="line">401942:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">401945:	e8 96 f8 ff ff       	callq  4011e0 &lt;strcmp@plt&gt;</span><br><span class="line">40194a:	85 c0                	test   %eax,%eax</span><br><span class="line">40194c:	75 1b                	jne    401969 &lt;phase_5+0xd6&gt;</span><br><span class="line">40194e:	bf 10 00 00 00       	mov    $0x10,%edi</span><br><span class="line">401953:	e8 28 f8 ff ff       	callq  401180 &lt;_Znwm@plt&gt;</span><br><span class="line">401958:	48 89 c3             	mov    %rax,%rbx</span><br><span class="line">40195b:	48 89 df             	mov    %rbx,%rdi</span><br><span class="line">40195e:	e8 65 06 00 00       	callq  401fc8 &lt;_ZN10worldline3C1Ev&gt;</span><br><span class="line">401963:	48 89 5d e8          	mov    %rbx,-0x18(%rbp)</span><br><span class="line">401967:	eb 05                	jmp    40196e &lt;phase_5+0xdb&gt;</span><br></pre></td></tr></table></figure>
<p>这里是一个比较，会根据 buf 进行 strcmp 来进入不同的路径。 但我们直接看这个地址，会发现这是不可见字符，而且最高的那个 bit 是 1。这里我们可以通过使用 gdb 中的 <code>x/s</code> 指令来打印这几个字符串：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/s 0x4032eb</span><br><span class="line">0x4032eb:       "杀杀杀！"</span><br><span class="line">pwndbg&gt; x/s 0x4032f8</span><br><span class="line">0x4032f8:       "退退退。"</span><br><span class="line">pwndbg&gt; x/s 0x403305</span><br><span class="line">0x403305:       "冲冲冲~"</span><br></pre></td></tr></table></figure>
<p>在每一条路径中，都会首先调用 <code>_Znwm@plt(0x10)</code>，然后将其作为参数调用 <code>_ZN10worldline1C1Ev</code> 、<code>_ZN10worldline2C1Ev</code> 或者 <code>_ZN10worldline3C1Ev</code>，并将 rbx 中的值存到 <code>-0x18(%rbp)</code> 中（下称 v18）。之所以这里将 rbx 而不是 rax 的值存到栈上，是因为 rbx 属于 callee saved 寄存器，在调用前后一定是不变的.</p>
<p>如果你给 objdump 加上了 <code>-C</code> 参数，又或者在 GDB 中查看这几个函数的话，你看到的名字应该是 <code>&lt;operator new(unsigned long)@plt&gt;</code>、<code>&lt;worldline1::worldline1()&gt;</code>、<code>&lt;worldline2::worldline2()&gt;</code> 以及 <code>&lt;worldline3::worldline3()&gt;</code>。</p>
<blockquote>
<p>不过我们发现很多同学没有用到 <code>-C</code> 参数，可能是因为我们的文档中还不够强调这一点，给大家先道个歉了（</p>
</blockquote>
<p>结合一些 C++的知识，我们可以知道 new 是类似 malloc 的用来动态分配一些空间的运算符，而这几个与类同名的函数则是类的初始化函数。</p>
<p>因此，这里的代码用 C++ 表示就是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">"杀杀杀！"</span>) == <span class="number">0</span>) {</span><br><span class="line">    v18 = new worldline1();</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">"退退退。"</span>) == <span class="number">0</span>) {</span><br><span class="line">    v18 = new worldline2();</span><br><span class="line">} <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(buf, <span class="string">"冲冲冲~"</span>) == <span class="number">0</span>) {</span><br><span class="line">    v18 = new worldline3();</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    explode_bomb();</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>我们先不跟进去看具体的类，继续看 phase_3，来掌握这一阶段的逻辑。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">40196e:	48 8b 45 e8          	mov    -0x18(%rbp),%rax</span><br><span class="line">401972:	48 8b 00             	mov    (%rax),%rax</span><br><span class="line">401975:	48 83 c0 10          	add    $0x10,%rax       # rax = *(uint64_t*)v18 + 0x10</span><br><span class="line">401979:	48 8b 08             	mov    (%rax),%rcx</span><br><span class="line">40197c:	8b 55 cc             	mov    -0x34(%rbp),%edx</span><br><span class="line">40197f:	48 8b 45 e8          	mov    -0x18(%rbp),%rax</span><br><span class="line">401983:	89 d6                	mov    %edx,%esi</span><br><span class="line">401985:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">401988:	ff d1                	callq  *%rcx</span><br></pre></td></tr></table></figure>
<p>我们可以看到这里调用了某个函数，这个函数地址保存在 <code>*(uint64_t*)v18 + 0x10</code> 处；调用函数的参数是 v18 和 v34。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">40198a:	85 c0                	test   %eax,%eax</span><br><span class="line">40198c:	74 10                	je     40199e &lt;phase_5+0x10b&gt;</span><br><span class="line">40198e:	48 8b 45 e8          	mov    -0x18(%rbp),%rax</span><br><span class="line">401992:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">401995:	e8 0c 05 00 00       	callq  401ea6 &lt;_ZN9worldline18is_phase5_passableEv&gt;</span><br><span class="line">40199a:	85 c0                	test   %eax,%eax</span><br><span class="line">40199c:	75 07                	jne    4019a5 &lt;phase_5+0x112&gt;</span><br><span class="line">40199e:	b8 01 00 00 00       	mov    $0x1,%eax</span><br><span class="line">4019a3:	eb 05                	jmp    4019aa &lt;phase_5+0x117&gt;</span><br><span class="line">4019a5:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">4019aa:	84 c0                	test   %al,%al</span><br><span class="line">4019ac:	74 05                	je     4019b3 &lt;phase_5+0x120&gt;</span><br><span class="line">4019ae:	e8 95 06 00 00       	callq  402048 &lt;explode_bomb&gt;</span><br></pre></td></tr></table></figure>
<p>我们仔细观察即可发现，如果上面这个未知的函数返回 0，炸弹就会爆炸。</p>
<p>函数然后调用了 <code>_ZN9worldline18is_phase5_passableEv()</code>（<code>worldline::is_phase5_passable()</code>），参数为 v18。如果这个函数返回 0，炸弹也会爆炸。</p>
<p>因此我们的目标有两个，一个是让未知的函数返回非 0 值，一个是让 <code>worldline::is_phase5_passable()</code> 返回非 0 值，这样就能够让 phase_5 函数正常返回。</p>
<p>接下来，我们会深入探究 C++面向对象机制，看看 class 和书上的 struct 到底有啥区别！</p>
<h4 id="面向对象机制的汇编实现">面向对象机制的汇编实现</h4>
<p>C++的 class 和 C 中的 struct，其最主要的区别就是类可以有成员函数。 一个最典型的成员函数，显然就是一个类的<strong>构造函数</strong>与<strong>析构函数</strong>。</p>
<p>我们首先来观察一下 <code>worldline1::worldline1()</code>，这里我们还是看加了 -C 参数得到的美化过的汇编代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">0000000000401ec8 &lt;worldline1::worldline1()&gt;:</span><br><span class="line">  401ec8:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  401ecc:	55                   	push   %rbp</span><br><span class="line">  401ecd:	48 89 e5             	mov    %rsp,%rbp</span><br><span class="line">  401ed0:	48 83 ec 10          	sub    $0x10,%rsp</span><br><span class="line">  </span><br><span class="line">Ⅰ 调用 worldline::worldline()</span><br><span class="line">  401ed4:	48 89 7d f8          	mov    %rdi,-0x8(%rbp)</span><br><span class="line">  401ed8:	48 8b 45 f8          	mov    -0x8(%rbp),%rax</span><br><span class="line">  401edc:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">  401edf:	e8 a4 ff ff ff       	callq  401e88 &lt;worldline::worldline()&gt;</span><br><span class="line">  </span><br><span class="line">Ⅱ 将 vtable 存放在 class 实例的第一个八字节</span><br><span class="line">  401ee4:	48 8d 15 85 3e 00 00 	lea    0x3e85(%rip),%rdx        # 405d70 &lt;vtable for worldline1+0x10&gt;</span><br><span class="line">  401eeb:	48 8b 45 f8          	mov    -0x8(%rbp),%rax</span><br><span class="line">  401eef:	48 89 10             	mov    %rdx,(%rax)</span><br><span class="line">  </span><br><span class="line">Ⅲ 将 0x8b690 存放在 class 实例的第二个八字节</span><br><span class="line">  401ef2:	48 8b 45 f8          	mov    -0x8(%rbp),%rax</span><br><span class="line">  401ef6:	48 c7 40 08 90 b6 08 	movq   $0x8b690,0x8(%rax)</span><br><span class="line"></span><br><span class="line">  401efd:	00 </span><br><span class="line">  401efe:	90                   	nop</span><br><span class="line">  401eff:	c9                   	leaveq </span><br><span class="line">  401f00:	c3                   	retq   </span><br><span class="line">  401f01:	90                   	nop</span><br></pre></td></tr></table></figure>
<p>再来看看 <code>worldline::worldline()</code>，我们看名字可以发现这个函数同样是一个初始化函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0000000000401e88 &lt;worldline::worldline()&gt;:</span><br><span class="line">  401e88:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  401e8c:	55                   	push   %rbp</span><br><span class="line">  401e8d:	48 89 e5             	mov    %rsp,%rbp</span><br><span class="line">  </span><br><span class="line">  401e90:	48 89 7d f8          	mov    %rdi,-0x8(%rbp)</span><br><span class="line">  401e94:	48 8d 15 fd 3e 00 00 	lea    0x3efd(%rip),%rdx        # 405d98 &lt;__cxa_pure_virtual@CXXABI_1.3&gt;</span><br><span class="line">  401e9b:	48 8b 45 f8          	mov    -0x8(%rbp),%rax</span><br><span class="line">  401e9f:	48 89 10             	mov    %rdx,(%rax)</span><br><span class="line">  </span><br><span class="line">  401ea2:	90                   	nop</span><br><span class="line">  401ea3:	5d                   	pop    %rbp</span><br><span class="line">  401ea4:	c3                   	retq   </span><br><span class="line">  401ea5:	90                   	nop</span><br></pre></td></tr></table></figure>
<p>不过这个函数做的唯一的事就是将 0x405d98 存放到参数的第一个八字节中。我们尝试看看这里有什么：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Contents of section .data.rel.ro:</span><br><span class="line"> 405d10 00000000 00000000 b05d4000 00000000  .........]@.....</span><br><span class="line"> 405d20 02204000 00000000 16204000 00000000  . @...... @.....</span><br><span class="line"> 405d30 2a204000 00000000 00000000 00000000  * @.............</span><br><span class="line"> 405d40 c85d4000 00000000 821f4000 00000000  .]@.......@.....</span><br><span class="line"> 405d50 961f4000 00000000 aa1f4000 00000000  ..@.......@.....</span><br><span class="line"> 405d60 00000000 00000000 e05d4000 00000000  .........]@.....</span><br><span class="line"> 405d70 021f4000 00000000 161f4000 00000000  ..@.......@.....</span><br><span class="line"> 405d80 2a1f4000 00000000 00000000 00000000  *.@.............</span><br><span class="line"> 405d90 f85d4000 00000000 00000000 00000000  .]@.............</span><br><span class="line"> 405da0 00000000 00000000 00000000 00000000  ................</span><br><span class="line"> 405db0 00000000 00000000 20334000 00000000  ........ 3@.....</span><br><span class="line"> 405dc0 f85d4000 00000000 00000000 00000000  .]@.............</span><br><span class="line"> 405dd0 30334000 00000000 f85d4000 00000000  03@......]@.....</span><br><span class="line"> 405de0 00000000 00000000 40334000 00000000  ........@3@.....</span><br><span class="line"> 405df0 f85d4000 00000000 00000000 00000000  .]@.............</span><br><span class="line"> 405e00 50334000 00000000                    P3@.....    </span><br></pre></td></tr></table></figure>
<p>虽然静态时只能看到一大堆 0，但是我们可以注意到这个 section 的名字中带有 rel 字样，在后面的章节中我们会学习动态链接机制，简单来说就是程序运行的时候才会将一些函数的地址填入到这里。我们可以动态调试看看这里的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/8gx 0x405d98</span><br><span class="line">0x405d98 &lt;_ZTV9worldline+16&gt;:   0x00007ffff7e80120      0x00007ffff7e80120</span><br><span class="line">0x405da8 &lt;_ZTV9worldline+32&gt;:   0x00007ffff7e80120      0x00007ffff7fa8c98</span><br><span class="line">0x405db8 &lt;_ZTI10worldline3+8&gt;:  0x0000000000403320      0x0000000000405df8</span><br><span class="line">0x405dc8 &lt;_ZTI10worldline2&gt;:    0x00007ffff7fa8c98      0x0000000000403330</span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/i 0x00007ffff7e80120</span><br><span class="line">   0x7ffff7e80120 &lt;__cxa_pure_virtual&gt;: endbr64</span><br></pre></td></tr></table></figure>
<p>我们可以看到，这里存放了一些函数地址，具体来说就是 <code>__cxa_pure_virtual</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7e80120 &lt;__cxa_pure_virtual&gt;: endbr64</span><br><span class="line">0x7ffff7e80124 &lt;__cxa_pure_virtual+4&gt;:       push   rax</span><br><span class="line">0x7ffff7e80125 &lt;__cxa_pure_virtual+5&gt;:       pop    rax</span><br><span class="line">0x7ffff7e80126 &lt;__cxa_pure_virtual+6&gt;:       mov    edx,0x1b</span><br><span class="line">0x7ffff7e8012b &lt;__cxa_pure_virtual+11&gt;:      lea    rsi,[rip+0xdc5d2]        # 0x7ffff7f5c704</span><br><span class="line">0x7ffff7e80132 &lt;__cxa_pure_virtual+18&gt;:      mov    edi,0x2</span><br><span class="line">0x7ffff7e80137 &lt;__cxa_pure_virtual+23&gt;:      sub    rsp,0x8</span><br><span class="line">0x7ffff7e8013b &lt;__cxa_pure_virtual+27&gt;:      call   0x7ffff7e72ba0 &lt;write@plt&gt;</span><br><span class="line">0x7ffff7e80140 &lt;__cxa_pure_virtual+32&gt;:      call   0x7ffff7e6f160 &lt;_ZSt9terminatev@plt&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到这个函数不是什么好函数，它直接调用了 <code>_ZSt9terminatev@plt</code>，即 <a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/error/terminate">std::terminate</a> 函数。</p>
<p>但其实我们知道这些对解题并没有什么帮助，因为在 <code>worldline1:worldline1()</code> 中，这个表被另一个表（vtable for worldline1）覆盖了，我们来看看这个表又是什么情况：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">405d70 021f4000 00000000 161f4000 00000000  ..@.......@.....</span><br><span class="line">405d80 2a1f4000 00000000 00000000 00000000  *.@.............</span><br></pre></td></tr></table></figure>
<p>可以看到，这里有三个函数地址，分别为 0x401f02，0x401f16 以及 0x401f2a，我们找到这几个函数，可以找到它们的定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0000000000401f02 &lt;worldline1::isWorldPeace()&gt;:</span><br><span class="line"></span><br><span class="line">0000000000401f16 &lt;worldline1::isEveryoneEqual()&gt;:</span><br><span class="line"></span><br><span class="line">0000000000401f2a &lt;worldline1::dmail(int)&gt;:</span><br></pre></td></tr></table></figure>
<p>至此，讲义可以初步揭晓此前的疑惑了：vtable 是一个<strong>函数表</strong>，它的地址会被存放在对应类的第一个八字节。</p>
<p>之所以 worldline1 的构造函数中调用了 worldline 的构造函数，是因为这两个类是<strong>基类</strong>和<strong>子类</strong>的关系。在 C++中，子类构造函数会先调用其基类的构造函数，然后再进行自己的构造函数，这就是这种机制的汇编实现。</p>
<p>之所以 worldline（基类）的 vtable 中的三个函数都是 terminate 函数，是因为基类将这几个函数声明为了<strong>纯虚函数</strong>，等待子类（worldline123）去实现。</p>
<p>因此，我们可以按照类似的流程找到 worldline2 和 worldline3 的 vtable，其中存放的就是 worldline2 类和 worldline3 类对同样的三个函数 <code>isWorldPeace()</code> <code>isEveryoneEqual()</code> <code>dmail()</code> 的实现。</p>
<p>于是，我们可以发现，phase_5 中调用的未知函数，其实是在类的 vtable 中根据偏移找到对于虚函数 <code>dmail(int)</code> 的实现，也就是 <code>worldline1::dmail(int)</code> 、<code>worldline2::dmail(int)</code> 或者 <code>worldline3::dmail(int)</code>。</p>
<p>我们分别查看这三个函数，可以发现：</p>
<ul>
<li><code>worldline1::dmail(int)</code> 对应参数 0x7e2（2018）</li>
<li><code>worldline2::dmail(int)</code> 对应参数 0x7e5（2021）</li>
<li><code>worldline3::dmail(int)</code> 对应参数 0x7e7（2023）</li>
</ul>
<p>然后我们查看 is_phase5_passable 函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0000000000401ea6 &lt;worldline::is_phase5_passable()&gt;:</span><br><span class="line">  401ea6:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  401eaa:	55                   	push   %rbp</span><br><span class="line">  401eab:	48 89 e5             	mov    %rsp,%rbp</span><br><span class="line">  401eae:	48 89 7d f8          	mov    %rdi,-0x8(%rbp)</span><br><span class="line">  401eb2:	48 8b 45 f8          	mov    -0x8(%rbp),%rax</span><br><span class="line">  401eb6:	48 8b 40 08          	mov    0x8(%rax),%rax</span><br><span class="line">  401eba:	48 3d 3f 42 0f 00    	cmp    $0xf423f,%rax</span><br><span class="line">  401ec0:	0f 9f c0             	setg   %al</span><br><span class="line">  401ec3:	0f b6 c0             	movzbl %al,%eax</span><br><span class="line">  401ec6:	5d                   	pop    %rbp</span><br><span class="line">  401ec7:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p>只有当传入指针的第二个八字节大于 0xf423f（999999）时，才能让这个函数返回非零值。</p>
<p><strong>一个类实例在虚函数表指针之后，就会顺序存放其各个成员函数域。</strong> 我们知道传入这个函数的指针是一个类实例的指针，因此这里我们可以知道它的第二个八字节是一个成员变量。其初始化可以在各子类的初始化函数找到：</p>
<ul>
<li><code>worldline1:worldline1()</code> 对应 0x8b690（571024）</li>
<li><code>worldline2:worldline2()</code> 对应 0x6f8d2（456914）</li>
<li><code>worldline3:worldline3()</code> 对应 0x1124fd（1123581）</li>
</ul>
<p>只有第三条世界线的这一成员变量跨越了 1000000 的界限，达到了通过的条件。</p>
<p>因此，本关需要达到第三条世界线，答案为 <code>冲冲冲~ 2023</code>。</p>
<p>最后，介绍一下本关所涉及的面向对象机制：</p>
<ul>
<li>一个类的内存结构由 vtable+成员变量构成。</li>
<li>非虚函数的成员函数（在本关中，<code>worldline::is_phase5_passable()</code> 就是一个非虚函数的成员函数，直接被子类继承了过去）和普通函数类似，但第一个参数一定是 this 指针。</li>
<li>一个虚函数就对应一个 vtable 中的偏移，程序会通过偏移去查找一个类实例的对应虚函数。</li>
<li>纯虚函数在 vtable 中被一个库函数代替（用来报错），否则就会指向具体的实现函数。</li>
<li>子类继承父类后，构造时会首先调用父类的构造函数，然后再进行自己的构造，比如把 vtable 替换为自己的 vtable。</li>
</ul>
<blockquote>
<p>更详细的机制可以阅读这个系列文章：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/homepage-category-835440-293.htm">从汇编角度学习C/C++</a></p>
</blockquote>
<h3 id="phase6循环队列">Phase6（循环队列）</h3>
<p>phase_6 主要考察大家一个数据结构，考虑可能部分同学还没有学到树形结构，于是出了一个循环队列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">401ac2:   e8 53 ff ff ff       callq  401a1a &lt;build_queue&gt;  </span><br><span class="line">401ac7:   48 89 45 b8          mov    %rax,-0x48(%rbp)  </span><br><span class="line">401acb:   48 8b 45 b8          mov    -0x48(%rbp),%rax  </span><br><span class="line">401acf:   48 89 45 90          mov    %rax,-0x70(%rbp)</span><br></pre></td></tr></table></figure>
<p>这段代码调用了一个<code>build_queue</code>函数，可以猜测其函数是生成了一个队列，结合循环队列的标题，可以猜测这个队列是循环队列。其返回值是0x406400,我们暂时不知道是什么，但是如果去检查<code>x /3wx 4219904</code>这个地址，可以发现一个变量名</p>
<p><code>0x406400 &lt;initialNodes+64&gt;: 0x00000014 0x00000000 0x004063c0</code> 是一个结构体，如果这里同学们没有看出来，再后来<code>getval</code>函数前检查传入参数也可以看出来，第一项是储存的值0x00000014 = 20，最后一项是下一个node的地址<code>0x004063c0</code>，可以通过不断的迭代查找到整个队列的内容</p>
<p>initialnode 读取<code>build_target()</code>里面的<code>rbp - 0x70</code>的内容，或根据<code>build_queue()</code>来找到链表的地址</p>
<table>
<thead>
<tr class="header">
<th>406400</th>
<th>4063c0</th>
<th>406410</th>
<th>4063e0</th>
<th>4063d0</th>
<th>4063f0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>20</td>
<td>60</td>
<td>40</td>
<td>50</td>
<td>10</td>
<td>30</td>
</tr>
<tr class="even">
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
</tr>
</tbody>
</table>
<p>找到三个循环</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">401ae6:   0f 8f 65 01 00 00    jg     401c51 &lt;build_target+0x1bb&gt;  </span><br><span class="line">401aec:   48 89 e0             mov    %rsp,%rax  </span><br><span class="line">401aef:   48 89 c3             mov    %rax,%rbx  </span><br><span class="line">401af2:   8b 45 c4             mov    -0x3c(%rbp),%eax</span><br></pre></td></tr></table></figure>
<p>第一个循环，最外层的循环，可以找到跳转地址就是比较答案的地址</p>
<p>循环里面内嵌了两个循环，两个循环分别调用<code>get_val</code>和<code>put_val</code>函数 我们通过检查函数传参和返回的结果来找到其作用</p>
<p>一个<code>put_val</code>的函数的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">4019c3:   48 89 7d f8          mov    %rdi,-0x8(%rbp)  </span><br><span class="line">4019c7:   89 75 f4             mov    %esi,-0xc(%rbp)  </span><br><span class="line">4019ca:   48 8b 45 f8          mov    -0x8(%rbp),%rax  </span><br><span class="line">4019ce:   48 8b 00             mov    (%rax),%rax     </span><br><span class="line">4019d1:   8b 55 f4             mov    -0xc(%rbp),%edx   #将第二个参数的值赋到第一个参数的地址  </span><br><span class="line">4019d4:   89 10                mov    %edx,(%rax)    </span><br></pre></td></tr></table></figure>
<p>输入 5 getval 5次 每次传入的地址分别是 406400，4063c0，406410，4063e0，4063d0 每次返回的值分别是 20，60，40，50，10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">401bf0: 89 04 8a             mov    %eax,(%rdx,%rcx,4) #取出的数字会保存到一个数组</span><br></pre></td></tr></table></figure>
<p>每次循环会保存取出来的数字</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">401c06:   8b 14 90             mov    (%rax,%rdx,4),%edx  </span><br><span class="line">401c09:   8b 45 c4             mov    -0x3c(%rbp),%eax  </span><br><span class="line">401c0c:   48 98                cltq     </span><br><span class="line">401c0e:   89 94 85 70 ff ff ff mov    %edx,-0x90(%rbp,%rax,4)  </span><br><span class="line">401c15:   8b 45 b4             mov    -0x4c(%rbp),%eax  </span><br><span class="line">401c18:   83 e8 01             sub    $0x1,%eax  </span><br><span class="line">401c1b:   89 45 cc             mov    %eax,-0x34(%rbp)</span><br></pre></td></tr></table></figure>
<p>我们在这里把数组中最后一个数字保存，这里没找出来其实不要紧，在最后面构造的答案里可以检查到</p>
<p>putval 5次 每次传入的地址分别是 406400，4063c0，406410，4063e0，4063d0 每次传入的值分别是 10，50，40，60，20</p>
<table>
<thead>
<tr class="header">
<th>406400</th>
<th>4063c0</th>
<th>406410</th>
<th>4063e0</th>
<th>4063d0</th>
<th>4063f0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>10</td>
<td>50</td>
<td>40</td>
<td>60</td>
<td>20</td>
<td>30</td>
</tr>
<tr class="even">
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
</tr>
</tbody>
</table>
<p>输入 6 getval 6次 每次传入的地址分别是 4063f0，406400，4063c0，406410，4063e0，4063d0 每次返回的值分别是 30，10，50，40，60，20</p>
<p>putval 6次 每次传入的地址分别是 4063f0，406400，4063c0，406410，4063e0，4063d0 每次传入的值分别是 20，60，40，50，10，30</p>
<table>
<thead>
<tr class="header">
<th>406400</th>
<th>4063c0</th>
<th>406410</th>
<th>4063e0</th>
<th>4063d0</th>
<th>4063f0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>30</td>
<td>10</td>
<td>60</td>
<td>40</td>
<td>06</td>
<td>20</td>
</tr>
<tr class="even">
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
<td>-&gt;</td>
</tr>
</tbody>
</table>
<p>-------&gt;找规律 对于输入的每个数，从循环队列中取对应数字的值，然后倒过来传入循环队列 答案数组保存取出的最后一个数字</p>
<p>-------&gt;暴力破解 bash、c++、python</p>
<p>最后记录的数组要求不严格递增,答案比较多 标准答案最后的数组是严格递增的<code>5 6 6 4 4 6</code></p>
<h3 id="secret-phase溢出-花指令">Secret Phase（溢出 &amp; 花指令）</h3>
<h4 id="溢出">溢出</h4>
<p>我们观察 <code>main.cpp</code>，很容易发现，我们根本没有办法进入 serect_phase，因为 secret_key 作为一个 main 函数中的局部变量，根本没有被其他函数引用的可能性。自始自终，它就是 0 而已。</p>
<p>但是，相信各位有着丰富写 bug 经验的程序员们，一定对各种 <strong>溢出（overflow）</strong> 不会陌生。最常见的溢出就是数组下标多了一个、少了一个；又或者你使用了不安全的 <code>gets()</code> 或 <code>scanf("%s")</code> 等等……这些都会导致溢出。</p>
<p>在 bomb 中，更准确地说就在 <code>main.cpp</code> 的代码最前面，我故意构造了一个溢出的漏洞：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_line</span><span class="params">(<span class="type">char</span>* input)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">char</span> ch;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">40</span>; i++) {</span><br><span class="line">        ch = <span class="built_in">getchar</span>();</span><br><span class="line">        <span class="keyword">if</span> (ch == <span class="string">'\n'</span>) {</span><br><span class="line">            input[i] = <span class="string">'\0'</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            input[i] = ch;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    input[i] = <span class="string">'\0'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="built_in">getchar</span>() != <span class="string">'\n'</span>); <span class="comment">// clear the input buffer</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<p>乍一眼一看，这函数并没有什么特别的，但是我们仔细观察循环条件，可以发现<strong>这个循环将会读取 40+1 个字符</strong>。而我们使用这个函数读取输入时，<strong>使用的 buffer（在 main 函数中）却是 40 字节的</strong>。</p>
<p>多读的那个字符会去哪里呢？光看代码我们是无法知道编译器如何安排内存的，我们可以观察 main 函数的汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">4013af:	48 8d 45 d0          	lea    -0x30(%rbp),%rax</span><br><span class="line">4013b3:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">4013b6:	e8 5b ff ff ff       	callq  401316 &lt;read_line&gt;</span><br></pre></td></tr></table></figure>
<p>这段代码可以说明 buffer 的位置就在 <code>-0x30(%rbp)</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">401487:	48 83 7d f8 00       	cmpq   $0x0,-0x8(%rbp)</span><br><span class="line">40148c:	74 4d                	je     4014db &lt;main+0x14c&gt;</span><br><span class="line">40148e:	48 8d 3d 8b 1c 00 00 	lea    0x1c8b(%rip),%rdi        # 403120 &lt;_IO_stdin_used+0x120&gt;</span><br><span class="line">401495:	e8 40 0c 00 00       	callq  4020da &lt;slow_put&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这段代码对应进入 secret_phase 之前的检查，可以发现 secret_key 的位置就在 <code>-0x8(%rbp)</code>。</p>
<p>这两个变量之间差了 0x28，也就是 40 个字节。因此，<strong>我们溢出的那一个字节会溢出到 secret_key 中</strong>，让 secret_key 不再为 0。</p>
<p>因此，我们在任意一个阶段输入一个超级长的字符串（满 41 字节即可），就能够溢出一个字节到 secret_key 中，从而欺骗这个世界，进入本不可能进入的 secret_phase 中。</p>
<blockquote>
<p>为了 Lab 的趣味性，请大家不要给认识的学弟/妹剧透本阶段！⊂彡☆))∀`)</p>
</blockquote>
<h4 id="花指令">花指令</h4>
<p>接下来让我们进入 secret_phase 函数体。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0000000000401db5 &lt;secret_phase&gt;:</span><br><span class="line">  401db5:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  401db9:	55                   	push   %rbp</span><br><span class="line">  401dba:	48 89 e5             	mov    %rsp,%rbp</span><br><span class="line">  401dbd:	48 83 ec 20          	sub    $0x20,%rsp</span><br><span class="line">  401dc1:	48 89 7d e8          	mov    %rdi,-0x18(%rbp)</span><br><span class="line">  401dc5:	eb ff                	jmp    401dc6 &lt;secret_phase+0x11&gt;</span><br><span class="line">  401dc7:	c0 48 8d 3d          	rorb   $0x3d,-0x73(%rax)</span><br><span class="line">  401dcb:	45 15 00 00 e8 2c    	rex.RB adc $0x2ce80000,%eax</span><br><span class="line">  401dd1:	f4                   	hlt    </span><br><span class="line">  401dd2:	ff                   	(bad)  </span><br></pre></td></tr></table></figure>
<p>进入函数的前六句汇编一切正常，但第七句突然出现了我们没有学过的 <code>rorb</code> 指令，甚至后面出现了 <code>hlt</code> 和 <code>(bad)</code> ，难道 secret_phase 是一个恶意的程序，想要让我们的 CPU 停止运行吗？</p>
<p>但我们发现，这些指令又不会运行，因为 0x401dc5 处进行了一次跳转，跳到了 0x401dc6 处。但问题又来了，0x401dc6 是 jmp 指令的中间，我们用 objdump 拿到的汇编代码中并没有这一条。</p>
<p>废话少说，让我们使用 gdb 来调试看看：</p>
<p>如果你为 gdb 安装了 pwndbg 插件，那么你可以直接看到代码的执行流是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">► 0x401db5 &lt;secret_phase&gt;       endbr64</span><br><span class="line">  0x401db9 &lt;secret_phase+4&gt;     push   rbp</span><br><span class="line">  0x401dba &lt;secret_phase+5&gt;     mov    rbp, rsp</span><br><span class="line">  0x401dbd &lt;secret_phase+8&gt;     sub    rsp, 0x20</span><br><span class="line">  0x401dc1 &lt;secret_phase+12&gt;    mov    qword ptr [rbp - 0x18], rdi</span><br><span class="line">  0x401dc5 &lt;secret_phase+16&gt;    jmp    secret_phase+17</span><br><span class="line">   ↓</span><br><span class="line">  0x401dc6 &lt;secret_phase+17&gt;    inc    eax</span><br><span class="line">  0x401dc8 &lt;secret_phase+19&gt;    lea    rdi, [rip + 0x1545]</span><br><span class="line">  0x401dcf &lt;secret_phase+26&gt;    call   puts@plt</span><br></pre></td></tr></table></figure>
<p>如果你没有安装插件，也可以借助 <code>display/5i $rip</code> 的力量，来观察这一个奇怪的跳转。</p>
<p>其实，这是一种让反汇编代码失效的技术，即一种对抗逆向工程的技术，被称为花指令（在国外叫做 junk code）。</p>
<p>位于 0x401dc5 处的 <code>eb ff</code> 是一条合法的指令 <code>jmp 0x401dc6</code>。 位于 0x401dc6 处的 <code>ff c0</code> 同样是一条合法的指令 <code>inc eax</code>。</p>
<p>我们可以看出，x86 家族的跳转非常灵活，甚至可以跳到一条指令的中间——<strong>指令对于 CPU 来说也只是内存中的数据而已，和别的内存数据并没有什么不同</strong>。</p>
<p>这里的花指令，我是借用内联汇编机制，手动声明字节来完成的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Junk Instructions</span></span><br><span class="line"><span class="comment"> *  ebff -&gt; jmp -1</span></span><br><span class="line"><span class="comment"> *  ffc0 -&gt; inc eax */</span></span><br><span class="line"><span class="keyword">asm</span>(<span class="string">".byte 0xeb, 0xff, 0xc0"</span> ::: <span class="string">"%eax"</span>);</span><br></pre></td></tr></table></figure>
<p>在此之后就是正常的逻辑了，程序会读取一个 unsigned int 并与 0xdeadc0de 异或，如果结果不是 0xbaadf00d 就会触发炸弹爆炸。</p>
<p>因此，本关卡的答案就是 0xdeadc0de XOR 0xbaadf00d == 1677734099</p>
<blockquote>
<p>P.S. 由于出题时间较短，本阶段大部分汇编代码实际上还是可以在 objdump 的反汇编中直接看到(´_ゝ`)</p>
</blockquote>
<h2 id="非标准解法">非标准解法</h2>
<p>如果说标准解法是通过静态分析和动态调试，完全理解程序的逻辑后，再推算构造出满足条件的输入的话；那么非标准解法就是指不完全理解程序逻辑，同样可以找到满足条件的输入。</p>
<h3 id="爆破">爆破</h3>
<p>确实是对本次 BombLab 非常有效的方法，也是在逆向工程中非常喜闻乐见的方法！</p>
<blockquote>
<p>炸弹就是要用爆破来进行硬碰硬，看看是你爆还是我爆！</p>
</blockquote>
<p>我们这里不放爆破脚本了，就简单介绍一些思路：</p>
<ul>
<li>在 Phase4 中，在阅读完 <code>phase_4()</code> 函数的代码后，答案空间已经缩小到了 0xe，可以直接进行爆破。</li>
<li>Phase6 同理，在阅读函数时，你会不断得到一些限制条件，然后就可以进行爆破！</li>
</ul>
<h3 id="符号执行">符号执行</h3>
<p>python 有一个可以求解方程组的库（准确地说叫做约束求解器），叫做 <code>z3</code>。</p>
<p>我们可以思考一下，我们做 BombLab 的时候，其实就是从汇编代码中解读出一系列对于输入字符串的<strong>限制</strong>，然后根据这些限制来求解出我们应该输入什么字符串的过程。我们做的事情不就是人脑约束求解吗？</p>
<p><strong>这个过程可以让程序来完成！</strong> 程序能够读取 bomb，将用到的变量（比如我们的输入）标记为<strong>符号</strong>，在运行过程中，根据我们所加的一些限制条件（比如不能走到 explode_bomb）计算出这些符号所应该满足的约束。这种技术就叫做<strong>符号执行</strong>。</p>
<p>最常用的符号执行工具之一，就是 <a target="_blank" rel="noopener" href="https://angr.io/">angr</a>。它的约束求解功能就是基于 <code>z3</code>。</p>
<p>我们这里就简单地使用 phase_4 为例，给大家演示一下流程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 加载 bomb 文件</span></span><br><span class="line">p = angr.Project(<span class="string">"./bomb"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置初始状态</span></span><br><span class="line">phase4_addr = <span class="number">0x4017f4</span></span><br><span class="line">initial_state = p.factory.blank_state(addr=phase4_addr)</span><br><span class="line"><span class="comment"># 随便找个地址，构造一个字符串“符号”，作为phase_4的参数</span></span><br><span class="line">input_addr = <span class="number">0x114514</span></span><br><span class="line">phase4_input = initial_state.solver.BVS(<span class="string">'phase4_input'</span>, <span class="number">40</span> * <span class="number">8</span>)</span><br><span class="line">initial_state.memory.store(input_addr, phase4_input)</span><br><span class="line">initial_state.regs.rdi = input_addr</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动模拟</span></span><br><span class="line">explode_addr = <span class="number">0x402048</span></span><br><span class="line">target_addr = <span class="number">0x401891</span>  <span class="comment"># phase4的leave;ret;所在的地址</span></span><br><span class="line">simulation = p.factory.simgr(initial_state)</span><br><span class="line">simulation.explore(find=target_addr, avoid=explode_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 打印结果</span></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(phase4_input, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"Oh..."</span>)</span><br></pre></td></tr></table></figure>
<p>安装完 angr 后启动这个脚本，等待几分钟，本关的答案就会被程序自动求出！（尽管这个答案看上去有些奇怪，但确实是能通过 phase4 的<em>一种</em>答案）</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ python se.py</span><br><span class="line">...</span><br><span class="line">b<span class="string">'51539607565h2\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到这个 python 脚本没有任何内容涉及到 phase_4 函数内部的逻辑，完全是程序自动根据我们设置的成功和避免条件来完成求解的。<del>（因此某些逆向手称之为 angr 一把梭）</del></p>
<p>其他的 phase 也可以用符号执行来进行求解，但需要具体问题具体分析：如果某个阶段中存在的分支实在太多，那么会出现<strong>状态爆炸</strong>的问题，需要我们通过一些技巧来避免。没错，符号执行中使用了类似于<em>状态机</em>的模型，每次遇到一个分支就会分出两个状态，并为这两个状态分别添加一个不同的约束。</p>
<p>感兴趣的同学可以阅读 <a target="_blank" rel="noopener" href="https://fanpu.io/blog/2020/breaking-cmu-bomblab-with-angr-for-fun-and-profit-part-1/">Breaking CMU's Bomblab with Angr for Fun and Profit - Part 1 | Fan Pu Zeng</a>，来看看这位仁兄是如何用 angr 来一把梭原版 BombLab 的。 如果你想要入门 angr ，可以阅读官方文档中的入门部分：<a target="_blank" rel="noopener" href="https://docs.angr.io/en/latest/core-concepts/toplevel.html">Core Concepts - angr documentation</a>。</p>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/ics/">Home</a></li>
         
          <li><a href="/ics/staff/">Staff</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cjinfdu/ics">Github</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%A2%98%E7%9B%AE%E8%A7%A3%E6%9E%90"><span class="toc-number">1.</span> <span class="toc-text">题目解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#phase1%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-number">1.1.</span> <span class="toc-text">Phase1（函数调用）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase2%E5%BE%AA%E7%8E%AF"><span class="toc-number">1.2.</span> <span class="toc-text">Phase2（循环）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase3%E5%88%86%E6%94%AF"><span class="toc-number">1.3.</span> <span class="toc-text">Phase3（分支）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase4%E9%80%92%E5%BD%92"><span class="toc-number">1.4.</span> <span class="toc-text">Phase4（递归）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase5%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.5.</span> <span class="toc-text">Phase5（面向对象）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E6%9C%BA%E5%88%B6%E7%9A%84%E6%B1%87%E7%BC%96%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.5.1.</span> <span class="toc-text">面向对象机制的汇编实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#phase6%E5%BE%AA%E7%8E%AF%E9%98%9F%E5%88%97"><span class="toc-number">1.6.</span> <span class="toc-text">Phase6（循环队列）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#secret-phase%E6%BA%A2%E5%87%BA-%E8%8A%B1%E6%8C%87%E4%BB%A4"><span class="toc-number">1.7.</span> <span class="toc-text">Secret Phase（溢出 &amp; 花指令）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%BA%A2%E5%87%BA"><span class="toc-number">1.7.1.</span> <span class="toc-text">溢出</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8A%B1%E6%8C%87%E4%BB%A4"><span class="toc-number">1.7.2.</span> <span class="toc-text">花指令</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%9E%E6%A0%87%E5%87%86%E8%A7%A3%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">非标准解法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%86%E7%A0%B4"><span class="toc-number">2.1.</span> <span class="toc-text">爆破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C"><span class="toc-number">2.2.</span> <span class="toc-text">符号执行</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://cjinfdu.github.io/ics/BombLab-Comment/"><i class="fa fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://cjinfdu.github.io/ics/BombLab-Comment/&text=BombLab writeup"><i class="fa fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://cjinfdu.github.io/ics/BombLab-Comment/&is_video=false&description=BombLab writeup"><i class="fa fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=BombLab writeup&body=Check out this article: https://cjinfdu.github.io/ics/BombLab-Comment/"><i class="fa fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://cjinfdu.github.io/ics/BombLab-Comment/&title=BombLab writeup"><i class="fa fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://cjinfdu.github.io/ics/BombLab-Comment/&name=BombLab writeup&description="><i class="fa fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
      <ul>
        <li id="toc"><a class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa fa-list fa-lg" aria-hidden="true"></i> TOC</a></li>
        <li id="share"><a class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa fa-share-alt fa-lg" aria-hidden="true"></i> Share</a></li>
        <li id="top" style="display:none"><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></li>
        <li id="menu"><a class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa fa-bars fa-lg" aria-hidden="true"></i> Menu</a></li>
      </ul>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2023 FDUICS-2023助教组
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/ics/">Home</a></li>
         
          <li><a href="/ics/staff/">Staff</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/cjinfdu/ics">Github</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/ics/lib/font-awesome/css/font-awesome.min.css">


<link rel="stylesheet" href="/ics/lib/meslo-LG/styles.css">


<link rel="stylesheet" href="/ics/lib/justified-gallery/justifiedGallery.min.css">


<!-- jquery -->

<script src="/ics/lib/jquery/jquery.min.js"></script>


<script src="/ics/lib/justified-gallery/jquery.justifiedGallery.min.js"></script>


<script src="/ics/js/main.js"></script>





